%------------------------------------------------------------------------------
% Geometry of page must be altered before playing around with fancy headers
\ifoptiondraft{
  % Even margins for draft mode
  \geometry{left=30mm, right=30mm, top=40mm, bottom=35mm}
}
{
  % Allow extra room for binding in final mode
  \geometry{left=35mm, right=25mm, top=40mm, bottom=35mm}
}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Introduce new column types to be used in tabularx. They allow use of the X
% column type whilst allowing to center text or align to the left or right

% https://tex.stackexchange.com/a/97188/181010
\newcolumntype{R}{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}X}
\newcolumntype{C}{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}X}
\newcolumntype{L}{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}X}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
\setlength{\headheight}{15pt}
\onehalfspacing
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Automatically center all floats and remove need to add \centering all the
% time 
\makeatletter
\g@addto@macro\@floatboxreset{\centering}
\makeatother
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Renew table environment to always centre content and use Minion Pro's tabular
% lining figures
\let\originaltable\table
\let\endoriginaltable\endtable
\renewenvironment{table}[1][ht]{%
	\originaltable[#1]
	\centering
	\figureversion{tabular,lf}
	}%
	{\endoriginaltable}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Formatting of part, chapter, section etc.

% Define titlehang to let sections etc protrude margin
\newcommand\titlehang[1]{%
    \llap{#1\hspace{2.5mm}}
}

% Get that big font (for use in \chapter}
\newcommand\YUGE{\fontsize{100}{120}\selectfont}

\titleformat{\part}%
  [display]% shape
  {\centering\Huge\scshape}% format applied to label+text
  {\color{partcolor}\textsc{\partname~\thepart}}% label
  {0pt}% horizontal separation between label and title body
  {}% code before the title body
  []% after the title body

\titleformat{\chapter}%
  [display]% shape
  {\YUGE\color{black!75}}% format applied to label+text
  {$\thechapter$}% label (use mathmode to get lined figures)
  {-1cm}% horizontal separation between label and title body
  {\huge\slshape\color{grey}}% before the title body
  [\hrule]% after the title body

\titleformat{\section}%
  [block]% shape
  {\large}% format applied to label+text
  {\titlehang\thesection}% label with titlehang
  {0em}% horizontal separation between label and title body
  {\scshape}% code before the title body
  []% after the title body

\titleformat{\subsection}%
  [block]% shape
  {\large}% format applied to label+text
  {\titlehang\thesubsection}% label with titlehang
  {0em}% horizontal separation between label and title body
  {\slshape}% before the title body
  []% after the title body

\titleformat{\subsubsection}%
  [block]% shape
  {\large}% format applied to label+text
  {}% label
  {0em}% horizontal separation between label and title body
  {\slshape}% before the title body
  []% after the title body

%\titlespacing{command}{left}{before}{after}
\titlespacing*{\chapter}{0pt}{30pt}{2ex plus 1ex}
\titlespacing*{\section}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex} 
\titlespacing*{\subsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus.2ex}
%----------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Fancy headers
\pagestyle{fancy}

% Remove hrule underneath header
\renewcommand{\headrulewidth}{0pt}

% See Figure 3 of fancyhdr documentation
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}{}}

% Set up to add file modification time / compiled time to draft mode 
\ifoptiondraft{
    \usepackage{currfile, filemod}
    \usepackage[ddmmyy]{datetime}
    \settimeformat{ampmtime}
    \renewcommand*{\thefilemodtime}[4]{\formattime{#1}{#2}{#3}}}{}

% Command to typeset file modification time, name and compile time
\newcommand{\setmod}{%
    \footnotesize last modified
    \FilemodToday{\currfilepath} \hfill \textbf{\currfilename} \hfill
    compiled \today\ \currenttime
}

% Style of plain pages
\fancypagestyle{plain}{%
    \fancyhf{}
    \fancyfoot[R]{\thepage}
    \ifoptiondraft{\fancyhead[CE,CO]{\setmod}}{}
}

% Headers for frontmatter
\fancypagestyle{front}{%
    \fancyhf{} 
    \fancyfoot[LE,RO]{\thepage}
    % If in draft mode add modified and compiled time to header
    \ifoptiondraft{\fancyhead[CE,CO]{\setmod}}{}}

% Header and footers for mainmatter
\fancypagestyle{main}{%
    \fancyhf{}
    \fancyhead[RO]{\textsc{\rightmark}\quad\thepage}
    \fancyhead[LE]{\thepage\quad\textsc{\leftmark}}
    % If in draft mode add modified and compiled time to footer
    \ifoptiondraft{\fancyfoot[CE, CO]{\setmod}}{}}

% Headers for backmatter
\fancypagestyle{back}{%
    \fancyhf{}
    \fancyhead[LE]{\thepage\quad}
    \fancyhead[RO]{\quad\thepage}
    % If in draft mode add modified and compiled time to footer
    \ifoptiondraft{\fancyfoot[CE, CO]{\setmod}}{}}


\appto\frontmatter{\pagestyle{front}}
\appto\mainmatter{\pagestyle{main}}
\appto\backmatter{\pagestyle{back}}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% You know it
\include{internal/colour_scheme}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Colour captions in draft mode, use bold font in final mode
\ifoptiondraft{%
    \captionsetup{format=hang, font=small, labelfont={color=link_purple}}
    }
    {%
    \captionsetup{format=hang, font=small, labelfont=bf}
    }
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Colour equation tag
\makeatletter
\renewcommand{\eqref}[1]{\textup{\eqreftagform@{\ref{#1}}}}
\let\eqreftagform@\tagform@
\def\tagform@#1{%
  \maketag@@@{\color{link_purple}(\ignorespaces#1\unskip\@@italiccorr)}%
}
\makeatother
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Make latex more willing to fill a page with large floats and small 
% amounts of text.
\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.9}
\renewcommand{\floatpagefraction}{0.8}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Set up hyperlinks
\hypersetup{
	final,
	linktocpage,
	pdfmenubar,
	colorlinks,
	linkcolor=link_purple,
	urlcolor=link_purple,
    	citecolor=black
}
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Ensure titles of Bibliography are set in sentence case
\DeclareFieldFormat{titlecase}{\MakeSentenceCase{#1}}
%------------------------------------------------------------------------------


